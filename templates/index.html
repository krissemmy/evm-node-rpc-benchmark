<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EVM Node RPC Bench</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    form {
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
    }

    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: 600;
    }

    input[type="text"],
    textarea,
    select,
    input[type="number"] {
      width: 100%;
      padding: 0.4rem;
      margin-top: 0.25rem;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 0.95rem;
    }

    textarea {
      min-height: 70px;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    button {
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background-color: #2563eb;
      color: white;
      font-weight: 600;
    }

    button[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    button:hover:enabled {
      background-color: #1d4ed8;
    }

    #timer {
      font-size: 0.9rem;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      text-align: left;
    }

    th {
      background-color: #f7f7f7;
    }

    .summary-table {
      margin-bottom: 1.5rem;
    }

    .success {
      color: #16a34a;
      font-weight: 600;
    }

    .error {
      color: #dc2626;
      font-weight: 600;
    }

    .small {
      font-size: 0.85rem;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>EVM Node RPC Bench</h1>
  <p class="small">
    Simple benchmark: choose method, RPS(Request Per Second), and duration.
  </p>
  <p class="small">
    Example url for Base node: <a HREF="https://base-rpc.publicnode.com">
        https://base-rpc.publicnode.com
      </a>
  </p>


  <form id="bench-form">
    <label for="url">Node RPC URL</label>
    <input
      type="text"
      id="url"
      name="url"
      required
      placeholder="https://your-node:8545"
      value="{{ form_values.url }}"
    />

    <label for="method">Method</label>
    <select id="method" name="method">
      <option value="eth_blockNumber" {% if form_values.method == "eth_blockNumber" %}selected{% endif %}>
        eth_blockNumber
      </option>
      <option value="eth_getBlockByNumber" {% if form_values.method == "eth_getBlockByNumber" %}selected{% endif %}>
        eth_getBlockByNumber (latest)
      </option>
    </select>

    <label for="headers">Headers (optional, JSON object)</label>
    <textarea
      id="headers"
      name="headers"
      placeholder='{"Authorization": "Bearer ..."}'
    >{{ form_values.headers }}</textarea>

    <label for="rps">Requests per second</label>
    <select id="rps" name="rps">
      <option value="5" {% if form_values.rps == 5 %}selected{% endif %}>5 RPS</option>
      <option value="10" {% if form_values.rps == 10 %}selected{% endif %}>10 RPS</option>
      <option value="15" {% if form_values.rps == 15 %}selected{% endif %}>15 RPS</option>
    </select>

    <label for="duration">Duration (seconds, max 60)</label>
    <select id="duration" name="duration">
      {% for s in range(5, 65, 5) %}
      <option value="{{ s }}" {% if form_values.duration == s %}selected{% endif %}>
        {{ s }} seconds
      </option>
      {% endfor %}
    </select>

    <div class="actions">
      <button type="submit" id="run-btn">Run benchmark</button>
      <span id="timer">Idle</span>
    </div>
  </form>

  <h2>Summary</h2>
  <table class="summary-table">
    <tbody id="summary-body">
      <!-- Filled by JS -->
    </tbody>
  </table>


  <script>
    (function () {
      const form = document.getElementById("bench-form");
      const timerEl = document.getElementById("timer");
      const runBtn = document.getElementById("run-btn");
      const summaryBody = document.getElementById("summary-body");

      let timerId = null;
      let currentSec = 0;
      let targetSec = 0;

      function startTimer(duration) {
        currentSec = 0;
        targetSec = duration;
        if (timerId) clearInterval(timerId);

        timerEl.textContent = `Running: 0 / ${targetSec} s`;
        timerId = setInterval(() => {
          currentSec += 1;
          if (currentSec >= targetSec) {
            timerEl.textContent = `Running: ${targetSec} / ${targetSec} s`;
            clearInterval(timerId);
            timerId = null;
          } else {
            timerEl.textContent = `Running: ${currentSec} / ${targetSec} s`;
          }
        }, 1000);
      }

      function stopTimer() {
        if (timerId) {
          clearInterval(timerId);
          timerId = null;
        }
        timerEl.textContent = `Done in ~${currentSec} s`;
      }

      function resetTimer() {
        if (timerId) {
          clearInterval(timerId);
          timerId = null;
        }
        currentSec = 0;
        targetSec = 0;
        timerEl.textContent = "Idle";
      }

      function renderSummary(summary) {
        if (!summary) {
          summaryBody.innerHTML = "";
          return;
        }

        function row(label, value) {
          return `<tr><th>${label}</th><td>${value}</td></tr>`;
        }

        summaryBody.innerHTML =
          row("Total requests", summary.total_requests) +
          row("Success", `<span class="success">${summary.total_success}</span>`) +
          row("Errors", `<span class="error">${summary.total_errors}</span>`) +
          row("Error rate", `${summary.error_rate.toFixed(2)}%`) +
          row("Latency min (ms)", summary.latency_min_ms.toFixed(2)) +
          row("Latency max (ms)", summary.latency_max_ms.toFixed(2)) +
          row("Latency avg (ms)", summary.latency_avg_ms.toFixed(2)) +
          row("Latency p90 (ms)", summary.latency_p90_ms.toFixed(2)) +
          row("Latency p95 (ms)", summary.latency_p95_ms.toFixed(2)) +
          row("Latency p99 (ms)", summary.latency_p99_ms.toFixed(2));
      }


      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const durationStr = formData.get("duration");
        const duration = durationStr ? parseInt(durationStr, 10) : 0;

        runBtn.disabled = true;
        startTimer(duration);
        summaryBody.innerHTML = "";

        try {
          const resp = await fetch("/run", {
            method: "POST",
            body: formData,
          });

          if (!resp.ok) {
            stopTimer();
            runBtn.disabled = false;
            alert("Benchmark failed: " + resp.status);
            return;
          }

          const data = await resp.json();
          stopTimer();
          renderSummary(data.summary);
        } catch (err) {
          stopTimer();
          alert("Error calling benchmark endpoint");
        } finally {
          runBtn.disabled = false;
        }
      });

      // Reset timer when page first loads
      resetTimer();
    })();
  </script>
</body>
</html>
